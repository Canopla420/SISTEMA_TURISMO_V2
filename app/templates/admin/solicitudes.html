{% extends "base.html" %}

{% block title %}Solicitudes - Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>📋 Solicitudes de Visitas</h1>
    <span class="badge bg-warning fs-6">{{ solicitudes|selectattr('estado', 'equalto', 'PENDIENTE')|list|length }} por revisar</span>
</div>

<!-- Estadísticas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3>{{ solicitudes|length }}</h3>
                <p class="mb-0">Total Solicitudes</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center">
                <h3>{{ solicitudes|selectattr('estado', 'equalto', 'PENDIENTE')|list|length }}</h3>
                <p class="mb-0">Pendientes</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3>{{ solicitudes|selectattr('estado', 'equalto', 'APROBADA')|list|length }}</h3>
                <p class="mb-0">Aprobadas</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h3>{{ solicitudes|selectattr('estado', 'equalto', 'RECHAZADA')|list|length }}</h3>
                <p class="mb-0">Rechazadas</p>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Solicitudes CON BOTÓN ELIMINAR -->
<div class="row">
    {% for solicitud in solicitudes %}
    <div class="col-md-6 mb-4">
        <div class="card border-{% if solicitud.estado == 'PENDIENTE' %}warning{% elif solicitud.estado == 'APROBADA' %}success{% else %}danger{% endif %}">
            <div class="card-header bg-{% if solicitud.estado == 'PENDIENTE' %}warning{% elif solicitud.estado == 'APROBADA' %}success{% else %}danger{% endif %} text-{% if solicitud.estado == 'PENDIENTE' %}dark{% else %}white{% endif %} d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">📋 Solicitud #{{ solicitud.id }}</h5>
                    <small>{{ solicitud.fecha_solicitud.strftime('%d/%m/%Y %H:%M') }}</small>
                </div>
                <!-- BOTÓN ELIMINAR EN EL HEADER -->
                <form method="POST" action="{{ url_for('admin.eliminar_solicitud', id=solicitud.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-outline-danger" 
                            onclick="return confirm('⚠️ ¿ELIMINAR permanentemente la solicitud #{{ solicitud.id }}? Esta acción NO se puede deshacer.')"
                            title="Eliminar solicitud">
                        🗑️
                    </button>
                </form>
            </div>
            <div class="card-body">
                <h6 class="card-title">🏫 {{ solicitud.nombre_institucion }}</h6>
                <p class="card-text">
                    <strong>📅 Fecha:</strong> {{ solicitud.fecha_solicitada.strftime('%d/%m/%Y') }}<br>
                    <strong>👥 Alumnos:</strong> {{ solicitud.cantidad_alumnos }}<br>
                    <strong>📍 Localidad:</strong> {{ solicitud.localidad }}<br>
                    <strong>📞 Contacto:</strong> {{ solicitud.responsable_nombre }} - {{ solicitud.responsable_telefono }}<br>
                    <strong>🎯 Nivel:</strong> {{ solicitud.nivel_educativo }}
                    {% if solicitud.edad_promedio %}
                    ({{ solicitud.edad_promedio }})
                    {% endif %}
                </p>
                <div class="mb-2">
                <strong>Prestadores solicitados:</strong>
                    <div>
                    {% for lugar in solicitud.lugares %}
                        <span class="badge bg-info me-1">{{ lugar }}</span>
                    {% endfor %}
                    </div>
                </div>
                <div class="mb-3">
                    <span class="badge bg-{% if solicitud.estado == 'PENDIENTE' %}warning{% elif solicitud.estado == 'APROBADA' %}success{% else %}danger{% endif %}">
                        {{ solicitud.estado }}
                    </span>
                </div>
                
                <!-- BOTONES DE ACCIÓN -->
                <div class="d-grid gap-2">
                    <div class="row">
                        <div class="col-6">
                            <a href="{{ url_for('admin.ver_solicitud', id=solicitud.id) }}" 
                               class="btn btn-outline-primary btn-sm w-100">📋 Ver Detalles</a>
                        </div>
                        <div class="col-6">
                            {% if solicitud.estado == 'PENDIENTE' %}
                            <a href="{{ url_for('admin.asignar_horarios', id=solicitud.id) }}" 
                               class="btn btn-warning btn-sm w-100">⏰ Horarios</a>
                            {% elif solicitud.estado == 'APROBADA' %}
                            <a href="{{ url_for('admin.asignar_horarios', id=solicitud.id) }}" 
                               class="btn btn-success btn-sm w-100">✅ Gestionar</a>
                            {% else %}
                            <span class="btn btn-outline-secondary btn-sm w-100 disabled">❌ Rechazada</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Mensaje si no hay solicitudes -->
{% if not solicitudes %}
<div class="alert alert-info text-center">
    <h4>ℹ️ No hay solicitudes registradas</h4>
    <p class="mb-3">Aún no se han recibido solicitudes de visitas.</p>
    <a href="{{ url_for('publico.solicitar_visita') }}" class="btn btn-primary">
        📝 Crear Primera Solicitud
    </a>
</div>
{% endif %}

<!-- Botón para crear nueva solicitud -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <a href="{{ url_for('publico.solicitar_visita') }}" class="btn btn-success">
            ➕ Nueva Solicitud de Visita
        </a>
    </div>
</div>
{% endblock %}