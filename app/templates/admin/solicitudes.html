{% extends "base.html" %}

{% block title %}Solicitudes - Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>ğŸ“‹ Solicitudes de Visitas</h1>
    <span class="badge bg-warning fs-6">{{ solicitudes|selectattr('estado', 'equalto', 'PENDIENTE')|list|length }} por revisar</span>
</div>

<!-- EstadÃ­sticas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3>{{ solicitudes|length }}</h3>
                <p class="mb-0">Total Solicitudes</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center">
                <h3>{{ solicitudes|selectattr('estado', 'equalto', 'PENDIENTE')|list|length }}</h3>
                <p class="mb-0">Pendientes</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3>{{ solicitudes|selectattr('estado', 'equalto', 'CONFIRMADA')|list|length }}</h3>
                <p class="mb-0">Aprobadas</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h3>{{ solicitudes|selectattr('estado', 'equalto', 'RECHAZADA')|list|length }}</h3>
                <p class="mb-0">Rechazadas</p>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Solicitudes CON BOTÃ“N ELIMINAR -->
<div class="row">
    {% for solicitud in solicitudes %}
      {% set est = (solicitud.estado or 'PENDIENTE')|upper %}
      <div class="col-md-6 mb-4">
        <div class="card border-{% if est == 'PENDIENTE' %}warning{% elif est == 'CONFIRMADA' %}success{% else %}danger{% endif %}">
          <div class="card-header bg-{% if est == 'PENDIENTE' %}warning{% elif est == 'CONFIRMADA' %}success{% else %}danger{% endif %} text-{% if est == 'PENDIENTE' %}dark{% else %}white{% endif %} d-flex justify-content-between align-items-center">
            <div>
              <strong>Solicitud #{{ solicitud.id }}</strong><br>
              <small class="text-muted">{{ solicitud.fecha_solicitud.strftime('%d/%m/%Y %H:%M') }}</small>
            </div>
            <div>
              <span class="badge {% if est=='CONFIRMADA' %}bg-success{% elif est=='RECHAZADA' %}bg-danger{% else %}bg-warning{% endif %}">{{ est }}</span>
            </div>
          </div>

          <div class="card-body">
            <h6 class="card-title">ğŸ« {{ solicitud.nombre_institucion }}</h6>
            <p>
              <strong>ğŸ“… Fecha:</strong> {{ solicitud.fecha_solicitada.strftime('%d/%m/%Y') }}<br>
              <strong>ğŸ‘¥ Alumnos:</strong> {{ solicitud.cantidad_alumnos }}<br>
            </p>

            <p><strong>Prestadores solicitados:</strong>
              {% for lugar in solicitud.lugares %}<span class="badge bg-info me-1">{{ lugar }}</span>{% endfor %}
            </p>

            <div class="mt-3">
              <div class="row g-2">
                <div class="col-12 col-sm-4">
                  <a href="{{ url_for('admin.ver_solicitud', id=solicitud.id) }}" class="btn btn-outline-primary btn-sm w-100">ğŸ“‹ Ver Detalles</a>
                </div>

                <div class="col-12 col-sm-4">
                  {% if est == 'PENDIENTE' %}
                    <a href="{{ url_for('admin.asignar_horarios', id=solicitud.id) }}" class="btn btn-warning btn-sm w-100">â° Horarios</a>
                  {% else %}
                    <a href="{{ url_for('admin.ver_solicitud', id=solicitud.id) }}" class="btn btn-success btn-sm w-100">âœ… Gestionar/Ver</a>
                  {% endif %}
                </div>

                <div class="col-12 col-sm-4">
                  <form method="POST" action="{{ url_for('admin.eliminar_solicitud', id=solicitud.id) }}" style="display:inline;">
                    {# Si usÃ¡s Flaskâ€‘WTF, incluÃ­ {{ csrf_token() }} aquÃ­ #}
                    <button class="btn btn-sm btn-outline-danger w-100" onclick="return confirm('Eliminar solicitud #{{ solicitud.id }}? Esta acciÃ³n eliminarÃ¡ tambiÃ©n las visitas asociadas.');">Eliminar</button>
                  </form>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    {% endfor %}
</div>

<!-- Mensaje si no hay solicitudes -->
{% if not solicitudes %}
<div class="alert alert-info text-center">
    <h4>â„¹ï¸ No hay solicitudes registradas</h4>
    <p class="mb-3">AÃºn no se han recibido solicitudes de visitas.</p>
    <a href="{{ url_for('publico.solicitar_visita') }}" class="btn btn-primary">
        ğŸ“ Crear Primera Solicitud
    </a>
</div>
{% endif %}

<!-- BotÃ³n para crear nueva solicitud -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <a href="{{ url_for('publico.solicitar_visita') }}" class="btn btn-success">
            â• Nueva Solicitud de Visita
        </a>
    </div>
</div>
{% endblock %}